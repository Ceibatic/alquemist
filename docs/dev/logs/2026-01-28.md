# 2026-01-28

## [00:00] reference-data — M07 audit implementation
- **Files:** `convex/roles.ts`, `convex/schema.ts`, `convex/units.ts`, `convex/seedUnits.ts`, `convex/seedAll.ts`, `components/users/role-selector.tsx`, `docs/modules/phase-1/M07-reference-data.md`
- **Why:** Audit found missing getById/getAssignableRoles in roles, units of measure completely unimplemented, useEffect dep bug in RoleSelector, and docs out of sync with real schema.
- **Commits:** `3a8112d`, `97ad242`, `1ea953d`, `604a524`, `9137548`

## [16:30] areas — M08 audit implementation
- **Files:** `convex/areas.ts`, `components/areas/area-card.tsx`, `components/areas/area-create-modal.tsx`, `app/(dashboard)/areas/[id]/edit/page.tsx`
- **Why:** Audit de M08 reveló gaps críticos de seguridad (auth guards faltantes), validación (nombres únicos), y UX (batch count hardcoded). Implementados fixes críticos e importantes.
- **Commits:** `99933e4`, `7f6f34c`, `82d57d9`

**Cambios implementados:**
1. Auth guards en todas las mutations (create, update, updateStatus, remove)
2. Validación de nombre único por instalación en create/update
3. Query getBatchCount para mostrar conteo real de lotes en cards
4. Mensajes de error mejorados mostrando errores del backend

**Pendiente:**
- Error boundaries (menor prioridad)
- Paginación en lista (menor prioridad)
- Lazy loading de tabs (menor prioridad)
- Campos de auditoría created_by/updated_by (menor prioridad)

## [18:00] cultivars — M15 audit implementation
- **Files:** `convex/cultivars.ts`, `components/cultivars/cultivar-list.tsx`, `components/cultivars/cultivar-card.tsx`, `app/(dashboard)/cultivars/[id]/edit/page.tsx`
- **Why:** Audit de M15 reveló gaps críticos de seguridad (auth guards faltantes en mutations, sin validación de ownership en queries), validación (sin unique name check), y UX (sin toasts, sin reactivate feature).
- **Commits:** `02ef0ae`, `2d30b33`, `6f226cb`

**Cambios implementados:**
1. Auth guards en todas las mutations (create, update, remove, reactivate)
2. Ownership validation en queries (get, list, getByFacility)
3. Unique name validation per company
4. Input sanitization (.trim() on all string fields)
5. Toast notifications en edit page (success/error)
6. Reactivate functionality para cultivares descontinuados
7. Show/hide discontinued checkbox en lista
8. Loading states durante delete operations

## [20:00] suppliers — M16 audit implementation
- **Files:** `convex/suppliers.ts`, `components/suppliers/supplier-list.tsx`
- **Why:** Audit de M16 reveló gaps críticos de seguridad (auth guards faltantes en mutations, sin validación de ownership en queries), validación (sin unique name check), y UX (sin mensajes específicos de error).
- **Commits:** `02ef0ae`, `2d30b33`, `2610e1e`

**Cambios implementados:**
1. Auth guards en todas las mutations (create, update, toggleStatus, remove)
2. Ownership validation en queries (get, list, getByCompany)
3. Unique name validation per company en create y update
4. Input sanitization (.trim() on all string fields)
5. Improved error handling mostrando mensajes específicos del backend
6. Toast notifications ya existían (no fue necesario modificar)
7. Loading states ya existían (no fue necesario modificar)

## [22:00] facilities — M18 audit implementation
- **Files:** `convex/facilities.ts`, `components/facilities/facility-list.tsx`, `components/facilities/facility-form.tsx`, `app/(dashboard)/facilities/[id]/page.tsx`
- **Why:** Audit de M18 reveló gaps críticos (validación de dependencias al eliminar, única instalación, auto-select), importantes (alerta vencimiento licencia, license read-only), y menores (visualización áreas, mapa GPS, filtro backend).
- **Commits:** `c3c7e09`, `bcb8d22`, `425832d`, `b58b9a2`, `138caa7`, `5194c9c`, `3d05470`, `80ea9ff`, `0c2ed6b`, `8b633da`, `15991eb`, `f36739b`

**Cambios implementados - Crítico:**
1. Validación para prevenir eliminar instalaciones con lotes activos (convex/facilities.ts)
2. Validación para prevenir eliminar única instalación activa (convex/facilities.ts)

**Cambios implementados - Importante:**
3. Auto-selección de otra instalación al eliminar la actual (facility-list.tsx)
4. Alerta de vencimiento de licencia <30 días en detail page con banners rojo/naranja ([id]/page.tsx)
5. Número de licencia read-only en modo edición con visual feedback (facility-form.tsx)

**Cambios implementados - Menor:**
6. Filtro backend por defecto a "active" para performance (convex/facilities.ts)
7. Visualización proporcional de áreas con barras de progreso ([id]/page.tsx)
8. Mapa embebido con OpenStreetMap para coordenadas GPS ([id]/page.tsx)
9. Eliminado archivo legacy facilities-content.tsx

**Resultado:** Módulo M18 ahora 100% production-ready con validaciones robustas, UX mejorado, y compliance regulatorio.

## [23:30] facilities — M18 code review fixes
- **Files:** `convex/facilities.ts`, `components/facilities/facility-list.tsx`, `app/(dashboard)/facilities/[id]/page.tsx`
- **Why:** Code review identificó 3 issues críticos: batch status validation incorrecta (usaba "completed" que no existe en schema), race condition en auto-select, y falta de seguridad en iframe + división por cero.
- **Commits:** `c7e2929`, `1655987`, `53cb109`

**Fixes implementados:**
1. Corregida validación de batch status para usar estados correctos del schema (active/harvested/split/merged vs archived/lost)
2. Agregado manejo de errores y exclusión explícita en auto-select para prevenir race condition
3. Añadidos atributos de seguridad al iframe (sandbox, encodeURIComponent) y checks de división por cero en visualización de áreas

**Resultado:** PR #11 aprobado para merge después de code review.

## [10:59] inventory — remove legacy adjust-stock-modal component
- **Files:** `components/inventory/adjust-stock-modal.tsx`, `docs/modules/phase-2/M19-inventory-management.md`
- **Why:** Legacy component adjust-stock-modal was replaced by inventory-movement-modal (Phase E architecture) but file remained in codebase. Verified no active code references, only outdated documentation link.
- **Commit:** `fa0cd59`

## [22:45] inventory — add auth guards and ownership validation
- **Files:** `convex/inventory.ts`
- **Why:** Security audit found missing authentication checks and ownership validation in inventory queries and mutations. Added auth guards to all 7 queries (list, getByFacility, getByCategory, getById, getLowStock, getTransactionHistory, getProductTransactionHistory) and ownership validation to mutations (update, remove) that modify data.
- **Commit:** `22d24b9`

## [11:06] facilities — correct batch status validation logic
- **Files:** `convex/facilities.ts`
- **Why:** Fixed incorrect batch status validation in facility removal. Was checking for non-existent "planning" status instead of correct schema statuses (active/harvested/split/merged). Now prevents deletion only when batches are truly in progress.
- **Commit:** `c7e2929`

## [11:06] facilities — add iframe security and fix division by zero
- **Files:** `app/(dashboard)/facilities/[id]/page.tsx`
- **Why:** Added embedded OpenStreetMap with security hardening (sandbox attribute, no-referrer policy, URL encoding) and area visualization bars with proper division-by-zero checks to prevent calculation errors.
- **Commit:** `53cb109`
