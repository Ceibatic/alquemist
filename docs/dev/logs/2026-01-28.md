# 2026-01-28

## [00:00] reference-data — M07 audit implementation
- **Files:** `convex/roles.ts`, `convex/schema.ts`, `convex/units.ts`, `convex/seedUnits.ts`, `convex/seedAll.ts`, `components/users/role-selector.tsx`, `docs/modules/phase-1/M07-reference-data.md`
- **Why:** Audit found missing getById/getAssignableRoles in roles, units of measure completely unimplemented, useEffect dep bug in RoleSelector, and docs out of sync with real schema.
- **Commits:** `3a8112d`, `97ad242`, `1ea953d`, `604a524`, `9137548`

## [16:30] areas — M08 audit implementation
- **Files:** `convex/areas.ts`, `components/areas/area-card.tsx`, `components/areas/area-create-modal.tsx`, `app/(dashboard)/areas/[id]/edit/page.tsx`
- **Why:** Audit de M08 reveló gaps críticos de seguridad (auth guards faltantes), validación (nombres únicos), y UX (batch count hardcoded). Implementados fixes críticos e importantes.
- **Commits:** `99933e4`, `7f6f34c`, `82d57d9`

**Cambios implementados:**
1. Auth guards en todas las mutations (create, update, updateStatus, remove)
2. Validación de nombre único por instalación en create/update
3. Query getBatchCount para mostrar conteo real de lotes en cards
4. Mensajes de error mejorados mostrando errores del backend

**Pendiente:**
- Error boundaries (menor prioridad)
- Paginación en lista (menor prioridad)
- Lazy loading de tabs (menor prioridad)
- Campos de auditoría created_by/updated_by (menor prioridad)

## [18:00] cultivars — M15 audit implementation
- **Files:** `convex/cultivars.ts`, `components/cultivars/cultivar-list.tsx`, `components/cultivars/cultivar-card.tsx`, `app/(dashboard)/cultivars/[id]/edit/page.tsx`
- **Why:** Audit de M15 reveló gaps críticos de seguridad (auth guards faltantes en mutations, sin validación de ownership en queries), validación (sin unique name check), y UX (sin toasts, sin reactivate feature).
- **Commits:** `02ef0ae`, `2d30b33`, `6f226cb`

**Cambios implementados:**
1. Auth guards en todas las mutations (create, update, remove, reactivate)
2. Ownership validation en queries (get, list, getByFacility)
3. Unique name validation per company
4. Input sanitization (.trim() on all string fields)
5. Toast notifications en edit page (success/error)
6. Reactivate functionality para cultivares descontinuados
7. Show/hide discontinued checkbox en lista
8. Loading states durante delete operations

## [20:00] suppliers — M16 audit implementation
- **Files:** `convex/suppliers.ts`, `components/suppliers/supplier-list.tsx`
- **Why:** Audit de M16 reveló gaps críticos de seguridad (auth guards faltantes en mutations, sin validación de ownership en queries), validación (sin unique name check), y UX (sin mensajes específicos de error).
- **Commits:** `02ef0ae`, `2d30b33`, `2610e1e`

**Cambios implementados:**
1. Auth guards en todas las mutations (create, update, toggleStatus, remove)
2. Ownership validation en queries (get, list, getByCompany)
3. Unique name validation per company en create y update
4. Input sanitization (.trim() on all string fields)
5. Improved error handling mostrando mensajes específicos del backend
6. Toast notifications ya existían (no fue necesario modificar)
7. Loading states ya existían (no fue necesario modificar)

## [10:51] facilities — Enhanced batch validation for facility deletion
- **Files:** `convex/facilities.ts`
- **Why:** Improved validation in remove mutation to prevent deleting facilities with any active batches (not just "active" and "planning" status, but any status except "completed").
- **Commit:** `c3c7e09`

## [11:15] facilities — Improved license number read-only UX in edit mode
- **Files:** `components/facilities/facility-form.tsx`
- **Why:** Enhanced visual feedback for read-only license number field in edit mode with gray background, cursor-not-allowed, and descriptive helper text for better user understanding.
- **Commit:** `3d05470`

## [10:53] facilities — Added license expiry alert banner for compliance
- **Files:** `app/(dashboard)/facilities/[id]/page.tsx`
- **Why:** Added visual compliance alerts in License tab to warn users when license is expired (red alert with days overdue) or expiring within 30 days (orange warning). Automatic calculation of days until expiry with clear call-to-action messages.
- **Commit:** `138caa7`

## [10:55] facilities — Filter inactive facilities by default in backend
- **Files:** `convex/facilities.ts`
- **Why:** Modified the list query to default to returning only "active" facilities when no status filter is provided. Clients can explicitly pass status="all" to get all facilities or status="inactive" for inactive only. Improves UX by hiding inactive facilities by default.
- **Commit:** `80ea9ff`

## [23:45] facilities — M18 code review fixes consolidated
- **Files:** `convex/facilities.ts`, `components/facilities/facility-list.tsx`, `app/(dashboard)/facilities/[id]/page.tsx`
- **Why:** Code review identificó 3 issues críticos: batch status validation incorrecta, race condition en auto-select, y falta de seguridad en iframe + división por cero.
- **Commit:** `481fb9e`

**Fixes implementados:**
1. Corregida validación de batch status para usar estados correctos del schema (active/harvested/split/merged vs archived/lost)
2. Agregado manejo de errores try-catch en auto-select para prevenir bloqueo si falla
3. Añadidos atributos de seguridad al iframe (sandbox, referrerPolicy=no-referrer, encodeURIComponent)
4. Checks de división por cero en visualización de áreas con Math.min caps

**Resultado:** PR #11 aprobado y listo para merge.

