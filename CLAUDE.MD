# CLAUDE.MD - Context Engineering Agent

**Alquemist Development Assistant**
**Version**: 1.0
**Target Context**: ~1500 tokens active

---

## Project Identity

**Alquemist** - Multi-region agricultural management SaaS platform for Cannabis, Coffee, Cocoa, and Flowers.

**Tech Stack (Final):**
- Frontend: Dual-mode (Bubble + Next.js 14)
- Database: Convex (serverless, real-time)
- Auth: Clerk (Organizations = Companies)
- API: RESTful API (v1) for frontend-agnostic access
- Deployment: Vercel + Convex Cloud
- i18n: UI 100% espa√±ol, datos t√©cnicos en ingl√©s (next-intl)

**Frontend Architecture:**
- **Bubble:** Frontend principal - 100% de la UI y orquestaci√≥n
- **Next.js:** Solo si complejidad t√©cnica lo requiere (decisi√≥n por m√≥dulo)
- **Shared Backend:** Single Convex database + REST API
- **Strategy:** Bubble-first, resolver complejidades t√©cnicas caso por caso

**Core Requirements:**
- Multi-tenant (company-based isolation)
- Batch-first tracking (50-1000 plants per batch)
- Regulatory compliance (configurable by region)
- Mobile PWA with offline capability
- Real-time updates via WebSocket

---

## Frontend Architecture

### Overview

Alquemist usa **arquitectura simplificada** - Bubble conecta directamente a servicios cloud:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Bubble App          ‚îÇ
‚îÇ   (UI Principal)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚Üí Clerk API (Auth)
         ‚îÇ   ‚Ä¢ Sign up / Sign in
         ‚îÇ   ‚Ä¢ JWT tokens
         ‚îÇ   ‚Ä¢ User management
         ‚îÇ
         ‚îú‚îÄ‚Üí Convex HTTP API (Database)
         ‚îÇ   ‚Ä¢ Queries (GET data)
         ‚îÇ   ‚Ä¢ Mutations (POST/PATCH/DELETE)
         ‚îÇ   ‚Ä¢ Real-time subscriptions
         ‚îÇ   ‚Ä¢ [Valida Clerk JWT]
         ‚îÇ
         ‚îî‚îÄ‚Üí GCP Cloud Functions (Opcional)
             ‚Ä¢ Vision AI (pest detection)
             ‚Ä¢ Document AI (form digitization)
             ‚Ä¢ Features complejas
             ‚Ä¢ [Solo cuando sea necesario]

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Next.js API (Vercel)  ‚îÇ ‚Üê Disponible pero NO usado inicialmente
‚îÇ   ‚Ä¢ Backend opcional    ‚îÇ   (Agregar solo si complejidad lo requiere)
‚îÇ   ‚Ä¢ /api/v1/*          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Filosof√≠a:** START SIMPLE ‚Üí Escala cuando sea necesario

### Backend Components

**Convex (Database + Backend):**
- `convex/schema.ts` - Database schema (26 tables)
- `convex/companies.ts` - Company queries & mutations
- `convex/facilities.ts` - Facilities queries & mutations
- `convex/batches.ts` - Batch tracking
- `convex/activities.ts` - Activity logging
- `convex/compliance.ts` - Compliance events
- `convex/inventory.ts` - Inventory management

**Next.js API (Opcional - NO usado en M√≥dulo 1):**
- `lib/api/middleware.ts` - Auth & validation
- `lib/api/errors.ts` - Error handling
- `lib/validations/schemas.ts` - Shared Zod schemas
- `app/api/v1/*` - REST endpoints (disponibles pero no usados)

**GCP Cloud Functions (Futuro):**
- Vision AI - Pest detection, quality checks
- Document AI - Form digitization
- Cloud Storage - Media files
- (Se implementa cuando m√≥dulos espec√≠ficos lo requieran)

### Implementation Strategy

**START SIMPLE (M√≥dulo 1-3):**
```
Bubble ‚Üí Clerk API (auth)
      ‚Üí Convex HTTP API (CRUD)
```
- No usar Next.js API inicialmente
- Validar Clerk JWT en Convex functions
- CRUD directo con Convex HTTP API

**ADD COMPLEXITY (Cuando sea necesario):**
```
Bubble ‚Üí Next.js API (Vercel) ‚Üí Convex
```
- Solo para business logic compleja
- Multi-step operations
- Transformaciones de data complejas
- Rate limiting / caching

**ADD GCP (M√≥dulos con IA):**
```
Bubble ‚Üí GCP Cloud Functions ‚Üí Vision AI / Document AI
                              ‚Üí Convex (save results)
```
- M√≥dulo 11: Quality Check Templates + AI
- M√≥dulo 13: AI Engine & Intelligent Services
- Decisi√≥n por feature espec√≠fico

### Development Workflow

**For Bubble Development (Principal):**

1. **Use API documentation** (referencia t√©cnica general):
   - [API-Integration.md](docs/core/API-Integration.md) - Gu√≠a general de integraci√≥n
   - [API-Bubble-Reference.md](docs/module-1/bubble/API-Bubble-Reference.md) - Referencia t√©cnica de endpoints

2. **Convex HTTP API (Direct Connection):**
   - ‚ö†Ô∏è NO existe plugin de Convex para Bubble
   - Conectar directamente a Convex HTTP API desde Bubble:
     ```
     Base URL: https://[your-deployment].convex.cloud
     Endpoint pattern: /api/query/[functionName] (GET)
                       /api/mutation/[functionName] (POST)
     Headers:
       - Authorization: Bearer [clerk-jwt-token]
       - Content-Type: application/json
     ```
   - Ejemplo query: `GET /api/query/companies:get?args={"id":"company123"}`
   - Ejemplo mutation: `POST /api/mutation/companies:create` con body JSON

3. **Autenticaci√≥n Clerk:**
   - ‚ö†Ô∏è NO existe plugin de Clerk para Bubble
   - Implementar autenticaci√≥n manualmente:
     ```
     Clerk Frontend API: https://[your-frontend-api].clerk.accounts.dev

     Sign In: POST /v1/client/sign_ins
     Sign Up: POST /v1/client/sign_ups
     Get Session: GET /v1/client/sessions/[session_id]
     ```
   - Obtener JWT token de Clerk session
   - Pasar token en header `Authorization: Bearer [token]` a Convex
   - Token se valida autom√°ticamente en Convex functions

4. **API Connector Setup en Bubble:**
   - Configurar 2 API connectors principales:
     - **Clerk API** - Autenticaci√≥n (sign in, sign up, user management)
     - **Convex API** - Database operations (queries + mutations)
   - Para cada endpoint, configurar manualmente en Bubble API Connector
   - Almacenar JWT token en Bubble's custom state
   - Incluir token en todos los requests a Convex

5. **C√≥digo e Implementaci√≥n:**
   - Los archivos de documentaci√≥n son **solo referencia t√©cnica**
   - El **c√≥digo real y llamados API espec√≠ficos** se proporcionan durante la implementaci√≥n de cada m√≥dulo
   - Cada m√≥dulo generar√° sus propios archivos de documentaci√≥n en `docs/module-X/bubble/`
   - Ejemplos de configuraci√≥n de API Connector se proporcionan por m√≥dulo

**UI Language (100% Espa√±ol):**
- Todos los textos visibles al usuario en espa√±ol
- Labels, botones, mensajes, placeholders ‚Üí espa√±ol
- Valores t√©cnicos en BD permanecen en ingl√©s (indoor, active, etc.)
- Traducciones aplicadas en Convex functions (antes de retornar datos)
- Mapping autom√°tico: DB "indoor" ‚Üí Response "Interior"
- Archivo de traducciones: `messages/es.json` (450+ traducciones)

**For Next.js Development (Solo si es necesario):**
- Se decide por m√≥dulo si complejidad t√©cnica requiere Next.js
- Agregar capa intermedia: Bubble ‚Üí Next.js API ‚Üí Convex
- Usar para: business logic compleja, multi-step operations, rate limiting
- Server Components para SEO, Client Components para interactivity

---

## Authentication Strategy

### Clerk JWT Validation in Convex

**Architecture Flow:**
```
1. User logs in via Bubble ‚Üí Clerk API
2. Clerk returns JWT token
3. Bubble stores token in custom state
4. Bubble ‚Üí Convex HTTP API (includes JWT in Authorization header)
5. Convex validates JWT and extracts user/org info
6. Query/Mutation executes with proper multi-tenant isolation
```

**Convex Function Example (with JWT validation):**

```typescript
// convex/companies.ts
import { query, mutation } from "./_generated/server";
import { v } from "convex/values";
import { getAuthUserId } from "./auth";

// Query example - requires authentication
export const list = query({
  args: {},
  handler: async (ctx) => {
    // Validate JWT and get user identity
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("Not authenticated");
    }

    // Extract organization ID from Clerk JWT
    const organizationId = identity.orgId;
    if (!organizationId) {
      throw new Error("No organization found");
    }

    // Multi-tenant query - only return company for this org
    return await ctx.db
      .query("companies")
      .filter((q) => q.eq(q.field("organization_id"), organizationId))
      .collect();
  },
});

// Mutation example - requires authentication
export const create = mutation({
  args: {
    name: v.string(),
    company_type: v.string(),
    // ... other fields
  },
  handler: async (ctx, args) => {
    // Validate JWT and get user identity
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("Not authenticated");
    }

    const organizationId = identity.orgId;
    if (!organizationId) {
      throw new Error("No organization found");
    }

    // Create company with automatic org isolation
    const companyId = await ctx.db.insert("companies", {
      ...args,
      organization_id: organizationId,
      created_by: identity.subject, // User ID from Clerk
      created_at: Date.now(),
      updated_at: Date.now(),
    });

    return companyId;
  },
});
```

**Key Points:**
- ‚úÖ Convex validates Clerk JWT automatically via `ctx.auth.getUserIdentity()`
- ‚úÖ Multi-tenant isolation enforced by filtering on `organization_id`
- ‚úÖ No need for separate auth middleware
- ‚úÖ User info (userId, orgId) extracted from JWT claims
- ‚úÖ All protected functions start with identity check

**Bubble Implementation:**
1. Store JWT token after Clerk login: `Set state token = [Clerk response token]`
2. Configure Convex API Connector with dynamic Authorization header:
   ```
   Header: Authorization
   Value: Bearer <token> (dynamic from custom state)
   ```
3. All Convex API calls automatically include JWT
4. Handle 401 errors ‚Üí redirect to login

---

## GCP Cloud Functions Strategy

### When to Use GCP

**START SIMPLE - NO usar GCP inicialmente**

GCP Cloud Functions son para casos espec√≠ficos con IA/ML:

**Use Cases for GCP:**
- ü§ñ **Vision AI**: Pest detection, quality inspections, plant health
- üìÑ **Document AI**: Form digitization, license scanning, label reading
- üß† **Custom ML Models**: Yield prediction, disease classification
- üìä **Heavy Processing**: Large batch operations, complex calculations

**Architecture with GCP:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Bubble App          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚Üí GCP Cloud Function (HTTPS endpoint)
         ‚îÇ   ‚Ä¢ Procesa imagen con Vision AI
         ‚îÇ   ‚Ä¢ Extrae datos con Document AI
         ‚îÇ   ‚Ä¢ Ejecuta modelo ML custom
         ‚îÇ   ‚îÇ
         ‚îÇ   ‚îî‚îÄ‚Üí Convex Mutation (guarda resultados)
         ‚îÇ       ‚Ä¢ Autenticaci√≥n: Service Account
         ‚îÇ       ‚Ä¢ Inserta datos en BD
         ‚îÇ
         ‚îî‚îÄ‚Üí Convex (refresh data)
             ‚Ä¢ Query para mostrar resultados
```

**Implementation Decision Per Module:**
- **M√≥dulo 1-10:** NO usar GCP (START SIMPLE)
- **M√≥dulo 11:** Quality Check Templates - evaluar si Vision AI agrega valor
- **M√≥dulo 13:** AI Engine - USAR GCP para features de IA
- **Decision criteria:** ¬øEl feature REQUIERE IA/ML o es "nice-to-have"?

**GCP Function Example:**
```javascript
// GCP Cloud Function - Pest Detection
const { ConvexHttpClient } = require("convex/browser");
const vision = require('@google-cloud/vision');

exports.detectPests = async (req, res) => {
  // 1. Validate request (API key, signature, etc.)
  const { imageUrl, batchId } = req.body;

  // 2. Process with Vision AI
  const client = new vision.ImageAnnotatorClient();
  const [result] = await client.objectLocalization(imageUrl);

  // 3. Analyze results
  const pests = result.localizedObjectAnnotations.filter(
    obj => PEST_LABELS.includes(obj.name)
  );

  // 4. Save to Convex
  const convex = new ConvexHttpClient(process.env.CONVEX_URL);
  await convex.mutation("activities:createPestDetection", {
    batch_id: batchId,
    pests_detected: pests.length,
    confidence: pests[0]?.score || 0,
    image_url: imageUrl,
  });

  // 5. Return results
  res.json({
    success: true,
    pests_found: pests.length,
    details: pests
  });
};
```

**When NOT to use GCP:**
- ‚ùå Simple CRUD operations ‚Üí Use Convex directly
- ‚ùå Business logic ‚Üí Consider Next.js API first
- ‚ùå Data transformations ‚Üí Can do in Convex functions
- ‚ùå User authentication ‚Üí Clerk handles this
- ‚ùå File uploads ‚Üí Use Convex file storage or Cloudinary

---

## Active Context

**Current Phase**: API Foundation Complete
**Active Module**: Ready to begin Module implementation
**Strategy**: Bubble-first frontend, backend API ready

**Context Files (Load on demand):**
- [Product-Requirements.md](docs/core/Product-Requirements.md) - 17 modules, feature specs
- [Technical-Specification.md](docs/core/Technical-Specification.md) - Architecture, patterns
- [Database-Schema.md](docs/core/Database-Schema.md) - 26 tables, regional configuration
- [API-Integration.md](docs/core/API-Integration.md) - REST API reference for Bubble integration

---

## Commands

### `@state current`
Show current project state, active module, and next steps.

**Output:**
- Git status (branch, uncommitted changes)
- Active module implementation progress
- Blockers or pending decisions
- Suggested next actions

---

### `@implement <feature>`
Load feature context and implement functionality.

**Process:**
1. Load relevant sections from Product-Requirements.md
2. Load relevant tables from Database-Schema.md
3. Apply patterns from Technical-Specification.md
4. Implement feature with regional requirements (default: Colombia)
5. For frontend features, decide: Bubble or Next.js implementation
6. Update Active Context with progress

**Example:**
```
@implement authentication
```

**Loads:**
- Product-Requirements.md ‚Üí MODULE 1 specs
- Database-Schema.md ‚Üí users, companies, roles tables
- Technical-Specification.md ‚Üí Clerk setup, multi-tenancy

---

### `@api <endpoint>`
Create or update API endpoint for frontend-agnostic access.

**Process:**
1. Load API-Integration.md for patterns
2. Create/update route handler in app/api/v1/
3. Add validation schemas in lib/validations/
4. Update API documentation
5. Test endpoint

**Example:**
```
@api batches
```

**Creates:**
- app/api/v1/batches/route.ts
- Updates API-Integration.md with endpoint docs

---

### `@review`
Review current implementation against requirements.

**Checks:**
- ‚úì Feature matches Product Requirements
- ‚úì Database schema matches Database-Schema.md
- ‚úì Tech stack follows Technical-Specification.md
- ‚úì Regional requirements implemented (i18n, multi-currency, regional codes)
- ‚úì Multi-tenancy enforced (companyId filtering)
- ‚úì Type safety (TypeScript end-to-end)

**Output:**
- Issues found with line numbers
- Compliance gaps
- Performance concerns
- Suggested fixes

---

### `@pr create <module>`
Generate comprehensive pull request for completed module.

**Process:**
1. Review all changes (git diff)
2. Verify module completion against Product-Requirements.md
3. Create PR with:
   - **Title**: `feat: implement MODULE X - <name>`
   - **Summary**: Feature overview (3-5 bullet points)
   - **Implementation Details**: Key technical decisions
   - **Regional Requirements**: Compliance implemented
   - **Database Changes**: Schema updates (if any)
   - **Testing**: Manual test checklist
   - **Screenshots**: UI changes (if applicable)

**Example:**
```
@pr create module-1
```

**Generates PR:**
```markdown
feat: implement MODULE 1 - Authentication & Company Setup

## Summary
- Clerk authentication with email/password + OAuth
- Company registration with regional business types
- Multi-tenant isolation via Clerk Organizations
- Multilingual UI with next-intl (default: Spanish)

## Implementation Details
- Convex schema: users, companies, roles tables
- Clerk Organizations mapped to companyId
- Row-level security in all queries
- Regional business entity types configurable

## Regional Requirements (Colombia Default)
‚úì Multi-language support (default: Spanish)
‚úì Business entity types (S.A.S, S.A., Ltda, etc.)
‚úì Tax ID validation pattern
‚úì Regional administrative codes (DANE for Colombia)
‚úì Timezone configurable (default: America/Bogota)

## Database Changes
Added 3 tables: companies, roles, users
See Database-Schema.md for full definitions

## Testing
- [ ] User registration with company
- [ ] Email verification flow
- [ ] Login with email/password
- [ ] OAuth login (Google)
- [ ] Multi-tenant isolation verified

## Next Module
MODULE 2 - Email Verification
```

---

## Workflow

**Simple 3-Step Process:**

### 1. Plan
- User specifies module/feature to implement
- Claude loads relevant context from core docs
- Confirms understanding and approach

### 2. Implement
- Claude implements feature following Technical-Specification.md
- Uses database schema from Database-Schema.md
- Applies regional requirements throughout (default: Colombia)
- Updates git commits incrementally

### 3. PR
- User requests PR creation with `@pr create <module>`
- Claude reviews completeness against Product-Requirements.md
- Generates comprehensive PR description
- Archives context in PR (no separate doc files needed)

**Archive Strategy:**
- PR descriptions document feature implementation
- Git commits track incremental progress
- No separate "planning docs" or "specs" needed
- Core docs (3 files) remain single source of truth

---

## Context Rules

**Keep Active Context Minimal:**
- Active module context only (~2000 tokens)
- Load feature specs on demand
- Use git history for completed work
- PR descriptions archive decisions

**When to Load Context:**
- `@implement` ‚Üí Load feature specs from Product-Requirements.md
- Schema changes ‚Üí Load relevant tables from Database-Schema.md
- Architecture questions ‚Üí Reference Technical-Specification.md
- Don't load entire docs, only relevant sections

**Git as Archive:**
- Each commit documents incremental progress
- PR descriptions capture full feature context
- Git history is queryable archive
- No need for separate "implementation logs"

---

## Documentation Organization

**Folder Structure:**
```
docs/
‚îú‚îÄ‚îÄ core/              # Documentos principales del proyecto
‚îÇ   ‚îú‚îÄ‚îÄ Product-Requirements.md
‚îÇ   ‚îú‚îÄ‚îÄ Technical-Specification.md
‚îÇ   ‚îú‚îÄ‚îÄ Database-Schema.md
‚îÇ   ‚îî‚îÄ‚îÄ API-Integration.md
‚îÇ
‚îú‚îÄ‚îÄ foundation/        # Configuraci√≥n inicial y setup
‚îÇ   ‚îú‚îÄ‚îÄ Authentication-Guide.md
‚îÇ   ‚îú‚îÄ‚îÄ Browser-API-Testing.md
‚îÇ   ‚îú‚îÄ‚îÄ Clerk-Organization-Setup.md
‚îÇ   ‚îî‚îÄ‚îÄ Implementation-Status.md
‚îÇ
‚îú‚îÄ‚îÄ module-X/          # Documentaci√≥n espec√≠fica de cada m√≥dulo
‚îÇ   ‚îú‚îÄ‚îÄ README.md     # √çndice del m√≥dulo
‚îÇ   ‚îú‚îÄ‚îÄ Module-X-Planning.md
‚îÇ   ‚îú‚îÄ‚îÄ Module-X-Quick-Start.md
‚îÇ   ‚îî‚îÄ‚îÄ bubble/       # Gu√≠as de implementaci√≥n en Bubble
‚îÇ       ‚îú‚îÄ‚îÄ Module-X-Bubble-Guide.md
‚îÇ       ‚îú‚îÄ‚îÄ API-Bubble-Reference.md
‚îÇ       ‚îî‚îÄ‚îÄ Bubble-UI-Wireframes.md
‚îÇ
‚îú‚îÄ‚îÄ dev/              # Frameworks y est√°ndares de desarrollo
‚îÇ   ‚îú‚îÄ‚îÄ Agentic-Dev-Framework.md
‚îÇ   ‚îú‚îÄ‚îÄ Agentic-Dev-System-Simple.md
‚îÇ   ‚îî‚îÄ‚îÄ Tech-Stack-Standard.md
‚îÇ
‚îî‚îÄ‚îÄ sessions/         # Res√∫menes de sesiones de trabajo
    ‚îî‚îÄ‚îÄ Session-Summary-YYYY-MM-DD.md
```

**Finding Documentation:**
- **Product specs:** `docs/core/Product-Requirements.md`
- **Tech architecture:** `docs/core/Technical-Specification.md`
- **Database schema:** `docs/core/Database-Schema.md`
- **API reference:** `docs/core/API-Integration.md`
- **Module guides:** `docs/module-X/` (cada m√≥dulo tiene su carpeta)
- **Bubble guides:** `docs/module-X/bubble/` (implementaci√≥n Bubble espec√≠fica)
- **Foundation docs:** `docs/foundation/` (setup, auth, testing)
- **Dev standards:** `docs/dev/` (frameworks, stack, guidelines)

**Creating New Module Documentation:**
1. Create folder: `docs/module-X/` (e.g., `docs/module-2/`)
2. Create `README.md` with module overview and links
3. Add planning documents (Planning, Task Board, etc.)
4. Add implementation guides (Quick Start, etc.)
5. If dual-frontend: Create `bubble/` subfolder with Bubble-specific docs
6. Update references in this CLAUDE.MD file

**Benefits of This Structure:**
- ‚úÖ Clear separation by concern (core, foundation, modules, dev)
- ‚úÖ Each module is self-contained with README
- ‚úÖ Easy to find documentation by category
- ‚úÖ Scalable for future modules (module-2, module-3, etc.)
- ‚úÖ Bubble documentation grouped per module
- ‚úÖ Development standards centralized in `dev/`

---

## Tech Constraints

**Internationalization Strategy:**
- **UI Language:** 100% espa√±ol - todos los textos visibles al usuario
- **Database Values:** Ingl√©s t√©cnico (indoor, active, greenhouse) para compatibilidad API
- **User Display:** Traducciones autom√°ticas desde messages/es.json
- **Example:** BD guarda "indoor", usuario ve "Interior"

**Regional Configuration (Colombia as Default):**
- Default locale: `es` (Spanish) - configurable per region
- Default currency: `COP` (format: $290.000) - multi-currency support
- Timezone: `America/Bogota` - configurable
- Regional administrative codes (e.g., DANE in Colombia)
- Coordinate systems configurable (MAGNA-SIRGAS for Colombia)
- Altitude units configurable (MSNM default)

**Business Types (Colombia Example):**
- S.A.S (Sociedad por Acciones Simplificada)
- S.A. (Sociedad An√≥nima)
- Ltda (Limitada)
- E.U. (Empresa Unipersonal)
- Persona Natural
- *Extensible for other regions*

**Compliance (Configurable by Region):**
- Cannabis: Regulatory tracking (e.g., INVIMA in Colombia)
- Agricultural chemicals: Registration validation (e.g., ICA in Colombia)
- Coffee: Quality standards (e.g., FNC in Colombia)
- Municipal: Business registration, permits
- *Architecture supports adding new regulatory frameworks*

**Data Architecture:**
- Multi-tenancy: Every record has `companyId`
- Batch-first: Default tracking unit (50-1000 plants)
- Individual plants: Optional for INVIMA compliance
- Audit trail: Immutable activity logs
- 5-year retention: Regulatory requirement

**Type Safety:**
- TypeScript strict mode
- Convex auto-generates types
- Zod validation for forms
- Server Actions type-safe by default

---

## Implementation Order

**Phase 1: Onboarding (Modules 1-8)**
1. Authentication & Company Setup
2. Email Verification
3. Subscription & Payments
4. Company Profile Completion
5. Facility Creation
6. Crop Type Selection
7. Area Setup with Sample Data
8. Cultivars & Suppliers Setup

**Phase 2: Core Operations (Modules 9-13)**
9. Inventory Management
10. Production Templates
11. Quality Check Templates + AI
12. Production Orders & Operations
13. AI Engine & Intelligent Services

**Phase 3: Advanced Features (Modules 14-17)**
14. Compliance & Reporting
15. Analytics & Business Intelligence
16. Mobile Experience & Media Management
17. Integrations & APIs

**Dependencies:**
- Each module builds on previous modules
- Cannot skip modules within a phase
- Cross-phase dependencies documented in Product-Requirements.md

---

## Example Session

```
User: @state current

Claude:
**Current State:**
- Branch: main
- Active Module: None (project not initialized)
- Next Steps:
  1. Initialize Next.js 14 project
  2. Set up Convex database
  3. Configure Clerk authentication
  4. Implement MODULE 1

**Suggested Command:**
@implement module-1

---

User: @implement module-1

Claude:
Loading MODULE 1 context...
‚úì Product-Requirements.md ‚Üí MODULE 1: Authentication & Company Setup
‚úì Database-Schema.md ‚Üí users, companies, roles tables
‚úì Technical-Specification.md ‚Üí Clerk setup, multi-tenancy patterns

Implementing MODULE 1...

[Creates files, implements features]

‚úì MODULE 1 complete

Test with:
npm run dev

Then request PR:
@pr create module-1

---

User: @pr create module-1

Claude:
Reviewing MODULE 1 implementation...
‚úì All features from Product-Requirements.md implemented
‚úì Database schema matches Database-Schema.md
‚úì Colombian requirements applied

Creating pull request...

[Generates comprehensive PR as shown in @pr create command above]

PR ready to create. Run:
git push origin feature/module-1
```

---

## Success Metrics

**Context Efficiency:**
- Active context: <2000 tokens (vs 8000+ in complex systems)
- Core docs: 3 files (vs 15+ in complex systems)
- PR-based archive (vs separate planning docs)

**Development Velocity:**
- Module implementation: 1-3 days per module
- PR review: <1 hour with comprehensive descriptions
- Context switching: <5 minutes (load on demand)

**Quality Indicators:**
- Type safety: 100% (TypeScript end-to-end)
- Colombian compliance: All requirements met
- Multi-tenancy: Enforced in all queries
- Real-time updates: WebSocket subscriptions

---

## Setup Instructions

### Initial Setup (One-Time)

**1. Clone Repository**
```bash
git clone <repository-url>
cd alquemist
npm install
```

**2. Set Up Convex**
```bash
# Initialize Convex (creates project if needed)
npx convex dev
```
- Creates a Convex account at [convex.dev](https://convex.dev)
- Sets up project: `alquemist`
- Generates `.env.local` with `CONVEX_DEPLOYMENT` and `NEXT_PUBLIC_CONVEX_URL`
- Press `Ctrl+C` after setup completes

**3. Set Up Clerk**
- Visit [clerk.com](https://clerk.com) and create account
- Create new application named "Alquemist"
- **Enable Organizations**: Settings ‚Üí Organizations ‚Üí Enable
- Configure auth methods: Email/Password + Google OAuth
- Copy API keys to `.env.local`:
  ```bash
  NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
  CLERK_SECRET_KEY=sk_test_...
  CLERK_FRONTEND_API_URL=https://....clerk.accounts.dev
  ```

**4. Install shadcn/ui Components (Optional)**
```bash
npx shadcn@latest add button card input label form
```

### Environment Variables

Required variables in `.env.local`:
```bash
# Convex (auto-generated by `npx convex dev`)
CONVEX_DEPLOYMENT=dev:your-deployment
NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud

# Clerk (from clerk.com dashboard)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
CLERK_FRONTEND_API_URL=https://....clerk.accounts.dev
```

### Development Workflow

**Start Development Servers:**
```bash
# Terminal 1: Next.js dev server
npm run dev

# Terminal 2: Convex dev server (watches schema changes)
npx convex dev
```

**Access Application:**
- **Bubble App:** https://[your-bubble-app].bubbleapps.io (Primary frontend)
- **Convex HTTP API:** https://[your-deployment].convex.cloud/api
  - Query endpoint: `/api/query/[functionName]`
  - Mutation endpoint: `/api/mutation/[functionName]`
- **Clerk API:** https://[your-frontend-api].clerk.accounts.dev
  - Sign in: `/v1/client/sign_ins`
  - Sign up: `/v1/client/sign_ups`
- **Dashboards:**
  - Convex Dashboard: https://dashboard.convex.dev
  - Clerk Dashboard: https://dashboard.clerk.com
- **Next.js (Opcional - solo desarrollo):** http://localhost:3000/api/v1

### CI/CD Pipeline

**Automatic Deployments:**
- **PR Preview**: Every PR triggers Vercel preview deployment
- **Production**: Push to `main` auto-deploys to production
- **Convex**: Schema deployed automatically via GitHub Actions

**Workflows:**
- `.github/workflows/ci.yml` - Lint, type-check, build verification
- `.github/workflows/deploy.yml` - Production deployment

**Required GitHub Secrets:**
```
VERCEL_TOKEN
CONVEX_DEPLOY_KEY
CLERK_SECRET_KEY (production)
```

### Deployment (Vercel + Convex)

**Vercel Setup:**
1. Connect GitHub repo to [vercel.com](https://vercel.com)
2. Add environment variables (Convex + Clerk keys)
3. Deploy: Automatic on `git push origin main`

**Convex Production Deployment:**
```bash
# Deploy schema to production
npx convex deploy --prod
```

### Testing

**Run Linter:**
```bash
npm run lint
```

**Type Check:**
```bash
npx tsc --noEmit
```

**Build Test:**
```bash
npm run build
```

---

## Implementation Status

### Foundation Phase ‚úÖ (100% COMPLETE)

**Completed (2025-10-10):**
1. ‚úÖ Project structure initialized (Next.js 15 + Convex + Clerk)
2. ‚úÖ Database schema deployed (26 tables, 97 indexes)
3. ‚úÖ Convex backend modules (6 core modules: companies, facilities, batches, activities, compliance, inventory)
4. ‚úÖ REST API integration (7 operational endpoints)
5. ‚úÖ Seed data system (5 roles, 4 crop types)
6. ‚úÖ API test scripts and documentation
7. ‚úÖ Multi-tenant architecture enforced and tested
8. ‚úÖ Type safety end-to-end
9. ‚úÖ **Clerk Organizations enabled and configured**
10. ‚úÖ **Organization creation UI implemented**
11. ‚úÖ **End-to-end testing completed successfully**
12. ‚úÖ **Test data created: Company + Facility**

**Test Results:**
- ‚úÖ Organization: `org_33saIMDJHDTLUJkAyxnxo5cYRSP`
- ‚úÖ Company: `jn7cx3afzv7zs555nrkp0pq9rx7s7c6d` (Alquemist Test Company)
- ‚úÖ Facility: Created (Greenhouse Facility #1, License: LIC-2025-001)
- ‚úÖ Multi-tenant isolation verified
- ‚úÖ All API endpoints operational with authentication

**Documentation:**
- [docs/foundation/Implementation-Status.md](docs/foundation/Implementation-Status.md) - Detailed status report
- [docs/foundation/Clerk-Organization-Setup.md](docs/foundation/Clerk-Organization-Setup.md) - Organization setup guide
- [docs/foundation/Browser-API-Testing.md](docs/foundation/Browser-API-Testing.md) - Complete testing guide
- [docs/foundation/Authentication-Guide.md](docs/foundation/Authentication-Guide.md) - Auth troubleshooting

### Module Implementation

**Current Status:** Foundation complete, ready to implement modules

**When Implementing a Module:**

1. **Check module documentation:**
   - Review `docs/module-X/README.md` for module overview
   - Read `docs/module-X/Module-X-Planning.md` for requirements

2. **For Bubble implementation (Default):**
   - Reference `docs/module-X/bubble/` for module-specific guides
   - Use general API reference: [API-Integration.md](docs/core/API-Integration.md)
   - Follow wireframes in `docs/module-X/bubble/Bubble-UI-Wireframes.md` if available
   - Los archivos de documentaci√≥n son **referencia t√©cnica**
   - El c√≥digo real y llamados API se proporcionan durante implementaci√≥n

3. **Implementation approach:**
   - **Default:** Build in Bubble
   - **If technical complexity requires:** Discuss Next.js option
   - Code and API calls provided during module implementation
   - Cada m√≥dulo genera su documentaci√≥n en `docs/module-X/bubble/`

**Available Modules:**
- **Module 1:** Company & Facility Setup ‚Üí [docs/module-1/](docs/module-1/)
- **Module 2-17:** To be implemented

**To Start a Module:**
```bash
@implement module-X  # e.g., @implement module-1
```

This will:
- Load module context from `docs/module-X/`
- Provide implementation guidance for Bubble
- Generate specific API calls and code for the module
- Create or update module-specific documentation
